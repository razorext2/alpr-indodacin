{% extends 'user/base.html' %} {% block title %} ALPR - {{data['title']}} {%
endblock %} {% block content %}
<!--begin::Main-->
<!--begin::Root-->
<div class="d-flex flex-column flex-root">
  <!--begin::Page-->
  <div class="page d-flex flex-row flex-column-fluid">
    <!--begin::Aside-->
    {% include 'user/aside.html' %}
    <!--end::Aside-->
    <!--begin::Wrapper-->
    <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
      <!--begin::Header-->
      {% include 'user/header.html' %}
      <!--end::Header-->
      <!--begin::Content-->
      <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
        <!--begin::Container-->
        <div class="container" id="kt_content_container">
          <div class="card mb-5 mb-xl-10">
            <div class="card-body pt-0 pb-0">
              <!--begin::Navs-->
              <ul
                class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bolder"
              >
                <!--begin::Nav item-->
                <li class="nav-item mt-2">
                  <a
                    class="nav-link text-active-primary ms-0 me-10 py-5"
                    href="{{url_for('user.detail_app', id = data.app_id)}}"
                    >License Plate</a
                  >
                </li>
                <!--end::Nav item-->
                <!--begin::Nav item-->
                <!-- <li class="nav-item mt-2">
                  <a
                    class="nav-link text-active-primary ms-0 me-10 py-5"
                    href="{{url_for('user.detail_api', id = data.app_id)}}"
                    >API</a
                  >
                </li> -->
                <!--end::Nav item-->

                <li class="nav-item mt-2">
                  <a
                    class="nav-link text-active-primary ms-0 me-10 py-5 active"
                    href="{{url_for('user.plate_color', id = data.app_id)}}"
                    >Plate Color</a
                  >
                </li>

                <!--begin::Nav item-->
                <li class="nav-item mt-2">
                  <a
                    class="nav-link text-active-primary ms-0 me-10 py-5"
                    href="{{url_for('user.setting_app', id = data.app_id)}}"
                    >Settings</a
                  >
                </li>
                <!--end::Nav item-->
              </ul>
              <!--begin::Navs-->
            </div>
          </div>
          <div class="card mb-5 mb-xl-10">
            <!--begin::Card header-->
            <div
              class="card-header border-0 cursor-pointer"
              data-bs-target="#kt_account_profile_details"
              aria-expanded="true"
              aria-controls="kt_account_profile_details"
            >
              <!--begin::Card title-->
              <div class="card-title m-0">
                <h3 class="fw-bolder m-0">License Plate</h3>
              </div>
              <!--end::Card title-->
              <div class="card-toolbar">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#kt_modal_add_plate_color"
                >
                  <!--begin::Svg Icon | path: icons/duotune/arrows/arr075.svg-->
                  <span class="svg-icon svg-icon-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <rect
                        opacity="0.5"
                        x="11.364"
                        y="20.364"
                        width="16"
                        height="2"
                        rx="1"
                        transform="rotate(-90 11.364 20.364)"
                        fill="black"
                      ></rect>
                      <rect
                        x="4.36396"
                        y="11.364"
                        width="16"
                        height="2"
                        rx="1"
                        fill="black"
                      ></rect>
                    </svg>
                  </span>
                  <!--end::Svg Icon-->Plate Color Detection
                </button>
              </div>
            </div>
            <!--begin::Card header-->
            <!--begin::Content-->
            <div class="card-body">
              <p>Test</p>
            </div>
            <!--end::Content-->
          </div>
        </div>
      </div>
      <!--end::Wrapper-->
    </div>
  </div>
  <div
    class="modal fade"
    id="kt_modal_edit_plate"
    tabindex="-1"
    style="display: none"
    aria-hidden="true"
  >
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
      <!--begin::Modal content-->
      <div class="modal-content">
        <!--begin::Modal header-->
        <div class="modal-header" id="kt_modal_edit_plate">
          <!--begin::Modal title-->
          <h2 class="fw-bolder">Edit Plate Number</h2>
          <!--end::Modal title-->
          <!--begin::Close-->
          <div
            class="btn btn-icon btn-sm btn-active-icon-primary"
            data-bs-dismiss="modal"
          >
            <!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
            <span class="svg-icon svg-icon-1">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
              >
                <rect
                  opacity="0.5"
                  x="6"
                  y="17.3137"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(-45 6 17.3137)"
                  fill="black"
                ></rect>
                <rect
                  x="7.41422"
                  y="6"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(45 7.41422 6)"
                  fill="black"
                ></rect>
              </svg>
            </span>
            <!--end::Svg Icon-->
          </div>
          <!--end::Close-->
        </div>
        <!--end::Modal header-->
        <!--begin::Modal body-->
        <div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
          <!--begin::Form-->
          <form
            id="plate_details"
            class="form fv-plugins-bootstrap5 fv-plugins-framework"
            action="#"
          >
            <!--begin::Scroll-->
            <div
              class="d-flex flex-column scroll-y me-n7 pe-7"
              id="kt_modal_add_user_scroll"
              data-kt-scroll="true"
              data-kt-scroll-activate="{default: false, lg: true}"
              data-kt-scroll-max-height="auto"
              data-kt-scroll-dependencies="#kt_modal_add_user_header"
              data-kt-scroll-wrappers="#kt_modal_add_user_scroll"
              data-kt-scroll-offset="300px"
            >
              <img
                id="plate_image"
                class="mx-auto my-1"
                src=""
                style="max-width: 200px"
              />
              <!--begin::Input group-->
              <div class="fv-row mb-7 fv-plugins-icon-container">
                <!--begin::Label-->
                <label class="required fw-bold fs-6 mb-2">Plate Number</label>
                <!--end::Label-->
                <!--begin::Input-->
                <input
                  type="hidden"
                  name="plate_id"
                  class="form-control form-control-solid mb-3 mb-lg-0"
                  id="plate_id"
                />
                <input
                  type="text"
                  name="plate_number"
                  class="form-control form-control-solid mb-3 mb-lg-0"
                  id="plate_number"
                  required
                />
                <!--end::Input-->
                <div
                  class="fv-plugins-message-container invalid-feedback"
                ></div>
              </div>
              <!--end::Input group-->
            </div>
            <!--end::Scroll-->
            <!--begin::Actions-->
            <div class="text-center pt-15">
              <button
                type="reset"
                class="btn btn-light me-3"
                data-bs-dismiss="modal"
              >
                Discard
              </button>
              <button id="edit_number" class="btn btn-primary">
                <span class="indicator-label">Submit</span>
                <span class="indicator-progress"
                  >Please wait...
                  <span
                    class="spinner-border spinner-border-sm align-middle ms-2"
                  ></span
                ></span>
              </button>
            </div>
            <!--end::Actions-->
            <div></div>
          </form>
          <!--end::Form-->
        </div>
        <!--end::Modal body-->
      </div>
      <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
  </div>

  <div id="imagemodal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header" id="kt_modal_edit_plate">
          <!--begin::Modal title-->
          <h4 class="fw-bolder">Preview Image</h4>
          <!--end::Modal title-->
          <!--begin::Close-->
          <div
            class="btn btn-icon btn-sm btn-active-icon-primary"
            data-bs-dismiss="modal"
          >
            <!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
            <span class="svg-icon svg-icon-1">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
              >
                <rect
                  opacity="0.5"
                  x="6"
                  y="17.3137"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(-45 6 17.3137)"
                  fill="black"
                ></rect>
                <rect
                  x="7.41422"
                  y="6"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(45 7.41422 6)"
                  fill="black"
                ></rect>
              </svg>
            </span>
            <!--end::Svg Icon-->
          </div>
          <!--end::Close-->
        </div>
        <div class="modal-body">
          <img
            class="imagepreview"
            src=""
            alt="Image preview"
            style="width: 100%"
          />
        </div>
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="kt_modal_add_plate_color"
    tabindex="-1"
    style="display: none"
    aria-hidden="true"
  >
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
      <!--begin::Modal content-->
      <div class="modal-content">
        <!--begin::Modal header-->
        <div class="modal-header" id="kt_modal_edit_plate">
          <!--begin::Modal title-->
          <h4 class="fw-bolder">Detect Plate Number</h4>
          <!--end::Modal title-->
          <!--begin::Close-->
          <div
            class="btn btn-icon btn-sm btn-active-icon-primary"
            data-bs-dismiss="modal"
          >
            <!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
            <span class="svg-icon svg-icon-1">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
              >
                <rect
                  opacity="0.5"
                  x="6"
                  y="17.3137"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(-45 6 17.3137)"
                  fill="black"
                ></rect>
                <rect
                  x="7.41422"
                  y="6"
                  width="16"
                  height="2"
                  rx="1"
                  transform="rotate(45 7.41422 6)"
                  fill="black"
                ></rect>
              </svg>
            </span>
            <!--end::Svg Icon-->
          </div>
          <!--end::Close-->
        </div>
        <!--end::Modal header-->
        <!--begin::Modal body-->
        <div class="modal-body scroll-y">
          <!--begin::Scroll-->
          <div
            class="d-flex flex-column scroll-y me-n7 pe-7"
            id="kt_modal_add_user_scroll"
            data-kt-scroll="true"
            data-kt-scroll-activate="{default: false, lg: true}"
            data-kt-scroll-max-height="auto"
            data-kt-scroll-dependencies="#kt_modal_add_user_header"
            data-kt-scroll-wrappers="#kt_modal_add_user_scroll"
            data-kt-scroll-offset="300px"
          >
            <!--begin::Input group-->
            <div class="container-fluid">
              <div class="row">
                <div class="col-6">
                  <h4>Upload Image</h4>
                  <form>
                    <div class="form-group">
                      <label for="file">Select an image:</label>
                      <input
                        type="file"
                        class="form-control"
                        id="file"
                        name="imageFile"
                        accept="image/*"
                      />
                    </div>
                  </form>
                </div>
                <div class="col-6">
                  <div class="preview-container">
                    <div id="preview" class="no-preview">No preview</div>
                  </div>
                </div>
              </div>
            </div>
            <!--end::Input group-->
          </div>
          <!--end::Scroll-->
          <!--begin::Actions-->
          <div class="text-center pt-15">
            <button
              type="reset"
              class="btn btn-light me-3"
              data-bs-dismiss="modal"
            >
              Discard
            </button>
            <button onclick="detect()" class="btn btn-primary" id="detect">
              Detect
            </button>
          </div>
          <!--end::Actions-->
        </div>
        <!--end::Modal body-->
      </div>
      <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
  </div>
  {% endblock %}

  <!--begin::Page Custom Javascript(used by this page)-->
  {% block script %}
  <script>
    function edit(id, lp, image) {
      $("#kt_modal_edit_plate").modal("toggle");
      $("#plate_image").attr("src", "/" + image);
      $("#plate_id").val(id);
      $("#plate_number").val(lp);
    }
    function hapus(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!",
      }).then(function (result) {
        if (result.isConfirmed) {
          // Check if the user clicked "Yes"
          $.ajax({
            url: '{{ url_for("user.crud_plate") }}',
            type: "DELETE",
            data: { id: id },
            success: function (response) {
              if (response.status == 1) {
                Swal.fire("Deleted!", "User has been deleted.", "success");
                location.reload();
              } else {
                Swal.fire("Error!", "Failed to delete user.", "error");
              }
            },
            error: function () {
              Swal.fire(
                "Error!",
                "An error occurred while deleting the user.",
                "error"
              );
            },
          });
        }
      });
    }

    function detect() {
      var fd = new FormData();
      var files = $("#file")[0].files;

      // Check file selected or not
      if (files.length > 0) {
        fd.append("imageFile", files[0]);
        console.log(fd);
        Swal.fire({
          title: "Are you sure?",
          text: "Detect Plate Number",
          icon: "warning",
          showCancelButton: true,
          showLoaderOnConfirm: true,
          confirmButtonText: "Yes,",
        }).then(function (result) {
          Swal.showLoading();
          $.ajax({
            url: '{{url_for("alpr.app", token = data.token)}}',
            type: "post",
            data: fd,
            contentType: false,
            processData: false,
            success: function (response) {
              if (response.status == 1) {
                Swal.fire("Sucess!", response.license, "success").then(
                  function () {
                    location.reload();
                  }
                );
              } else {
                Swal.fire("Error!", response.message, "error");
              }
            },
          });
        });
      } else {
        Swal.fire({
          title: "Error!",
          text: "Silahkan pilih file terlebih dahulu.",
          icon: "error",
          confirmButtonText: "Ok",
        });
      }
    }
    $("#edit_number").click(function (e) {
      e.preventDefault();
      $.ajax({
        url: '{{url_for("user.crud_plate")}}',
        type: "put",
        data: $("#plate_details").serialize(),
        success: function (response, status, xhr, $form) {
          if (response.status == 1) {
            toastr.success(response.message);
            setTimeout(function () {
              location.reload();
            }, 2000);
          } else {
            toastr.error(response.message);
          }
        },
      });
    });
    $("#kt_datatable_example_1").DataTable({
      filter: true,
      deferRender: true,
      searching: true,
    });

    jQuery(document).ready(function ($) {
      // Add more attributes to the img.pop
      $(".pop").attr("data-toggle", "tooltip");
      $(".pop").attr("data-placement", "top");
      $(".pop").attr("title", "Click to see a bigger photo.");

      // Current viewport size
      var wW = $(window).width() * 0.9;
      var wH = $(window).height() * 0.9; // Max display

      $('[data-toggle="tooltip"]').tooltip();

      $(".pop").on("click", function () {
        var img = $(this).find("img")[0];
        console.log("Image element:", img);

        if (img) {
          // Ensure the image is fully loaded before accessing its properties
          if (img.complete) {
            showImageModal(img);
          } else {
            $(img).on("load", function () {
              showImageModal(img);
            });
          }
        } else {
          console.error("Image element not found within .pop");
        }
      });

      function showImageModal(img) {
        console.log("Showing modal for image:", img.src);

        // Real size of the photo
        var rW = img.naturalWidth;
        var rH = img.naturalHeight;

        console.log("Image natural dimensions:", rW, rH);

        var cW, cH; // Photo's will be set to this size!
        cW = rW;
        cH = rH; // Initial setting

        if (rH < wH) {
          if (rW > wW) {
            cW = wW;
            cH = (wW * rH) / rW;
          }
        } else {
          if (rW < wW) {
            cH = wH;
            cW = (wH * rW) / rH;
          } else if ((wW * rH) / rW < wH) {
            cW = wW;
            cH = (wW * rH) / rW;
          } else {
            cH = wH;
            cW = (wH * rW) / rH;
          }
        }

        console.log("Calculated dimensions:", cW, cH);

        // Show max photo's size if it's smaller than the current viewport. Otherwise, it scales the photo to the size of the viewport.
        $(".modal-dialog").css({ width: cW + "px", height: cH + "px" });

        $(".imagepreview").attr("src", $(img).attr("src"));
        $("#imagemodal").modal("show");
      }
    });

    document
      .getElementById("file")
      .addEventListener("change", function (event) {
        var file = event.target.files[0];
        var previewContainer = document.getElementById("preview");

        if (file) {
          var reader = new FileReader();
          reader.onload = function (e) {
            var img = new Image();
            img.src = e.target.result;
            img.alt = "Image preview";
            img.style.maxWidth = "100%";
            img.style.maxHeight = "300px";

            // Clear the previous content and show the new image
            previewContainer.innerHTML = "";
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else {
          // Show a default "No preview" message
          previewContainer.innerHTML = "No preview";
        }
      });
  </script>
  {% endblock %}
  <!--end::Page Custom Javascript-->
</div>
